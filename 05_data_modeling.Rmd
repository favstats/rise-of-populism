---
title: "Data Modeling"
output: html_notebook
---

**TODO**
*methods*
fixing the factor analysis plot
description of parties
citation citations citations (rewriting mlr)
*analysis*
Probability Plots for the main hypotheses
*coding*
TODO: Globalism und Govsat fixen
TODO: Choose which interactions
*appendix*
table of all parties and their score

# Loading in Data and packages

```{r}
load("data/mlogit_ess.Rdata")

pacman::p_load(tidyverse, writexl, haven, sjPlot, sjmisc, texreg, psych, labelled, broom, magrittr, BaylorEdPsych, lmtest, datapasta, car, BBmisc, stargazer, caret, DescTools, rcompanion, tidyeval, mgcv, countrycode)

#pacman::p_install_gh("wilkelab/cowplot")
#devtools::install_github("gadenbuie/regexplain")

range01 <- function(x){(x - min(x, na.rm = T)) / (max(x, na.rm = T) - min(x, na.rm = T))}


mlogit_ess %>% 
  group_by(cntry, target) %>% 
  tally() %>% #select(cntry) %>% unique()

```



# Mlogit

```{r}
library(nnet)
mlogit_ess$populism2 <- relevel(mlogit_ess$target, ref = "Establishment")

test <- multinom(
  populism2 ~
    # economic deprivation
    econ_insec + unemployed + welfare +
    # cultural backlash
    anti_imm + openness + conservation + selfenhance + selftrans + globalism + govsat +
    # control variables
    age + educ + sex + lrscale + ethnic + religion + rural + east + north + south +
    year_2016 + year_2014 + year_2012,
    #data
    data = mlogit_ess, weights = pweight)

# screenreg(test)
# stargazer::stargazer(test, type = "text")

multi1.rrr <- exp(coef(test))

stargazer::stargazer(test, type = "text",coef=list(multi1.rrr), p.auto=FALSE)

summary(test)

#car::Anova(test)

PseudoR2(test)

regm2 <- step(test)
# 
# GGally::ggcoef(regm2, exponentiate = TRUE) + facet_grid(~y.level)

tidy(regm2, exponentiate = T, conf.int = TRUE) %>% 
  # filter(term != "south") %>% 
  # filter(term != "east") %>% 
  # filter(term != "north") %>% 
  # filter(term != "(Intercept)") %>% 
  ggplot() + aes(x = term, y = estimate, 
                 ymin = conf.low, 
                 ymax = conf.high, color = y.level) + 
  geom_hline(yintercept = 1, 
             color = "gray25", 
             linetype = "dotted") + 
  geom_errorbar(position = position_dodge(0.5), width = 0) + 
  geom_point(position = position_dodge(width = 0.5)) + scale_y_log10() + 
  coord_flip()

```


# Sequentalism

**TODO**
- Populist Parties by Country (map)
- Plots: 
*descriptives*
Regional Plot (how many populists per region)
Boxplot:  age + educ + sex + lrscale+ religion + rural 
Populist Parties by Country (map)
*analysis*
Coefficent Plots (one big motherfucker)
Probability Plots for the main hypotheses

TODO: Globalism und Govsat fixen
TODO: Choose which interactions

```{r}




library(nnet)
mlogit_ess$populism2 <- relevel(mlogit_ess$target, ref = "Establishment")

controls <- multinom(
  populism2 ~
    # economic deprivation
    #econ_unsat + econ_insec + unemployed + welfare +
    # cultural backlash
    #anti_imm + openness + conservation + selfenhance + selftrans +
    # control variables
    age + educ + sex + lrscale + ethnic + religion + rural + globalism + govsat + east + north + south +
    year_2016 + year_2014 + year_2012,
    #data
    data = mlogit_ess, weights = pweight)

# controls_tidy <- step(controls) %>% 
#   tidy(exponentiate = T, conf.int = TRUE) %>% 
#   mutate(model = "control") %>% 
#   mutate(stars = get_p_values(p.value)) %>% 
#   mutate(mcfadden = round(PseudoR2(controls), 2)) 

  # cowplot::add_sub(gg_coefs, 
  #                  label = paste(expression(paste("McFadden's Pseudo R^2:")), 
  #                                           gg_coefs$mcfadden), 
  #                  x = 0, hjust = 0) %>%
  # cowplot::ggdraw()

fit1 <- multinom(
  populism2 ~
    # control variables
    age + educ + sex + lrscale + ethnic + religion + rural + globalism + govsat + east +
    north + south + year_2016 + year_2014 + year_2012 +
    # economic deprivation
    econ_insec + unemployed + welfare,
    # cultural backlash
    #anti_imm + openness + conservation + selfenhance + selftrans + globalism + govsat +
    #data
    data = mlogit_ess, weights = pweight)

# fit1_tidy <- step(fit1) %>% 
#   tidy(exponentiate = T, conf.int = TRUE) %>% 
#   mutate(model = "control") %>% 
#   mutate(stars = get_p_values(p.value)) %>% 
#   mutate(mcfadden = round(PseudoR2(fit1), 2)) 


fit2 <- multinom(
  populism2 ~
    # control variables
    age + educ + sex + lrscale + ethnic + religion + rural + globalism + govsat + east +
    north + south +  year_2016 + year_2014 + year_2012+
    # economic deprivation
    #econ_unsat + econ_insec + unemployed + welfare +
    # cultural backlash
    anti_imm + openness + conservation + selfenhance + selftrans,
    #data
    data = mlogit_ess, weights = pweight)


fit3 <- multinom(
  populism2 ~
    # control variables
    age + educ + sex + lrscale + ethnic + religion + rural + globalism + govsat + east +
    north + south +   year_2016 + year_2014 + year_2012+
    # economic deprivation
    econ_insec + unemployed + welfare +
    # cultural backlash
    anti_imm + openness + conservation + selfenhance + selftrans,
    #data
    data = mlogit_ess, weights = pweight)

fit4 <- multinom(
  populism2 ~
    # control variables
    age + educ + sex + lrscale + ethnic + religion + rural + globalism + govsat + east +
    north + south +   year_2016 + year_2014 + year_2012+
    # economic deprivation
    econ_insec + unemployed + welfare +
    # cultural backlash
    anti_imm + openness + conservation + selfenhance + selftrans +
    # interactions
    welfare * anti_imm ,
    #data
    data = mlogit_ess, weights = pweight)

# PseudoR2(controls)
# PseudoR2(fit1)
# PseudoR2(fit2)
# PseudoR2(fit3)
# PseudoR2(fit4)
#

tidy(fit4) %>% 
  filter(term %nin% c("(Intercept)", "age", "educ", "sex", 
                     "lrscale", "ethnic", "religion", "rural", 
                     "globalism", "govsat", "east", "north", "south", 
                     "year_2016", "year_2014", "year_2012", "econ_insec", 
                     "unemployed", "welfare", "anti_imm", "openness", 
                     "conservation", "selfenhance", "selftrans")) %>% 
  mutate(stars = get_p_values(p.value)) 

```

## one big one plot

```{r}
get_p_values <- function (pval) {
  dplyr::case_when(
    is.na(pval) ~ "", 
    pval < 0.001 ~ "***", 
    pval < 0.01 ~ "**", 
    pval < 0.05 ~ "*", TRUE ~ "")
}

prep_dat <- function(model, modelname) {
  tidy_model <- step(model) %>% 
    tidy(exponentiate = T, conf.int = TRUE) %>% 
  mutate(model = modelname) %>% 
  mutate(stars = get_p_values(p.value)) 
  
tidy_model$mcfadden <- round(PseudoR2(model), 2)
  
  return(tidy_model)
}


anovies <- c("-", paste0(
round(c(anova(controls, fit1)$`LR stat.`[2],
anova(controls, fit2)$`LR stat.`[2],
anova(fit2, fit3)$`LR stat.`[2],
anova(fit3, fit4)$`LR stat.`[2]), 2),

c(anova(controls, fit1)$`Pr(Chi)`[2],
anova(controls, fit2)$`Pr(Chi)`[2],
anova(fit2, fit3)$`Pr(Chi)`[2],
anova(fit3, fit4)$`Pr(Chi)`[2]) %>% 
  get_p_values()
))



# # screenreg(test)
#  stargazer::stargazer(controls, fit1, fit2, fit3, type = "html", apply.coef = exp, p.auto=FALSE)

all_mods <- rbind( 
prep_dat(controls, "control"),
prep_dat(fit1, "model1"),
prep_dat(fit2, "model2"),
prep_dat(fit3, "model3"),
prep_dat(fit4, "model4")
) 

mcfaddies <- all_mods %>% 
  group_by(model, mcfadden) %>% 
  tally() %>%
  .$mcfadden

unique(all_mods$term)


control_variables <- c("age", "educ", "sex", "lrscale", "ethnic", 
  "religion", "rural", "south", "east", "north", 
             "globalism", "govsat")
  
economic <- c("econ_insec", "unemployed", "welfare")

cultural <- c("anti_imm", "openness", 
             "conservation", "selfenhance", "selftrans")

all_mods %>% 
  filter(term != "south") %>% 
  filter(term != "east") %>% 
  filter(term != "north") %>% 
  filter(term != "year_2016") %>% 
  filter(term != "year_2014") %>% 
  filter(term != "year_2012") %>% 
  filter(term != "(Intercept)") %>% 
  mutate(variable_groups = case_when(
    term %in% control_variables ~ "Controls",
    term %in% economic ~ "Economic",
    term %in% cultural ~ "Cultural",
    TRUE ~ "Interactions"
  )) %>% 
  mutate(model = case_when(
    model == "control" ~ "Model 1 (Controls)",
    model == "model1" ~ "Model 2 (Economic)",
    model == "model2" ~ "Model 3 (Culture)",
    model == "model3" ~ "Model 4 (Economic + Culture)",
    model == "model4" ~ "Model 5 (Interactions)"
  )) %>%
  mutate(term = case_when(
    term == "anti_imm" ~ "Anti-Immigration Sentiment", 
    term == "openness" ~ "Openness", 
    term == "conservation" ~ "Conservation", 
    term == "selfenhance" ~ "Self-Enhancement", 
    term == "selftrans" ~ "Self-Transcendence", 
    term == "econ_insec" ~ "Economic Insecurity", 
    term == "unemployed" ~ "Unemployed (0/1)", 
    term == "welfare" ~ "Welfare (0/1)",
    term == "age" ~ "Age", 
    term == "educ" ~ "Education", 
    term == "sex" ~ "Female (0/1)", 
    term == "lrscale" ~ "Left-Right Scale", 
    term == "ethnic" ~ "Ethnic Minority (0/1)", 
    term == "religion" ~ "Religiosity", 
    term == "rural" ~ "Rural (0/1)",  
    term == "globalism" ~ "Trust in Global Governance", 
    term == "govsat" ~ "Government Satisfaction",
    TRUE ~ "Unemployed X Anti-Immigration Sentiment"
  )) %>% 
  mutate(term = fct_relevel(term, levels = c("Unemployed X Anti-Immigration Sentiment",
                              "Anti-Immigration Sentiment", "Openness", 
                              "Conservation", "Self-Enhancement", "Self-Transcendence", 
                              "Econ Insecurity", "Unemployed (0/1)", 
                              "Welfare (0/1)",
                              "Age", "Education", "Female (0/1)", "Left-Right Scale", 
                              "Ethnic Minority (0/1)", "Religiosity", "Rural (0/1)",
                              "Trust in Global Governance", "Government Satisfaction"))) %>% 
  ggplot() + aes(x = term, y = estimate, 
                 ymin = conf.low, 
                 ymax = conf.high, 
                 color = y.level) + 
  geom_hline(yintercept = 1, 
             color = "gray25", 
             linetype = "dotted") + 
  geom_errorbar(position = position_dodge(0.5), width = 0) + 
  geom_point(aes(shape = variable_groups), 
             position = position_dodge(width = 0.5)) + 
  scale_y_log10() +
  geom_vline(xintercept = seq(1.5, length(unique(all_mods$term)) - 0.5, 1), 
             lwd = 1, colour = "grey", alpha = 0.7) +
  geom_text(aes(x = term, 
                y = estimate + 0.01,
                label = paste(sprintf('%.2f', estimate, 2), stars)), 
                position = position_dodge(1.2)) +
  coord_flip() +
  scale_y_continuous(breaks = seq(-2,2, by = 0.3)) +
  ggthemes::theme_hc() +
  ggthemes::scale_fill_fivethirtyeight() +
  cowplot::background_grid(major = 'y', minor = "none") + # add thin horizontal lines
  cowplot::panel_border() +# and a border around each panel
  xlab("") +
  ylab("Odds Ratios") + 
  # labs(caption = paste(expression("McFadden's Pseudo R^2:")), 
  #                                          gg_coefs$mcfadden) +
  facet_grid(~ model, scales = "fixed") +
  annotate("label", x = -1, y = 1, label = paste("McFadden's R2.:",
                                                  mcfaddies,
                                                  "\n N:", rep(nrow(mlogit_ess), 5),
                                                  "\n LRT:", anovies)) +
  # annotate("label", x = 7.5, y = 0.7, label = "Controls") +
  # annotate("label", x = 11.5, y = 0.7, label = "Economic") +
  # annotate("label", x = 18.5, y = 0.7, label = "Cultural") +
  # annotate("label", x = 19.5, y = 0.7, label = "Interactions") +
  # expand_limits(x = 21) + 
  geom_text(aes(x = -2, label = "")) +
  scale_x_discrete(limits = c("Unemployed X Anti-Immigration Sentiment",
                              "Interactions",
                              "Anti-Immigration Sentiment", "Openness", 
                              "Conservation", "Self-Enhancement", "Self-Transcendence", 
                              "Culture",
                              "Economic Insecurity", "Unemployed (0/1)", 
                              "Welfare (0/1)",
                              "Economics",
                              "Age", "Education", "Female (0/1)", "Left-Right Scale", 
                              "Ethnic Minority (0/1)", "Religiosity", "Rural (0/1)",
                              "Trust in Global Governance", "Government Satisfaction",
                              "Controls"), 
                   labels = c("Controls"=expression(displaystyle(bold(Controls))), 
                            "Economics"=expression(displaystyle(bold(Economics))),
                            "Culture"=expression(displaystyle(bold(Culture))), 
                            "Interactions"=expression(displaystyle(bold(Interactions))), 
                            parse=TRUE))

ggsave(filename = "images/onebigmotherfucker.png", width = 15, height = 10)
 
# multi1.rrr <- exp(coef(test))
# 
# stargazer::stargazer(test, type="text",coef=list(multi1.rrr), p.auto=FALSE)

# TODO Make a map (or two)
# TODO Make stuff citeable
# TODO Decide which interactions
# TODO Make probability plots

unique(all_mods$term)
```


# Citation Stuff

```{r}

cite_dat <- data.frame(anovies = anovies, model = unique(all_mods$model)) %>% 
  right_join(all_mods)

cite_dat %>% 
  filter(model == "control") %>% 
  mutate(id = 1:n()) %>% 
  select(y.level, term, estimate) %>% 
  spread("term", "estimate")

get_p_cite <- function (pval) {
  dplyr::case_when(is.na(pval) ~ "", 
                   pval < 0.001 ~ "< 0.001",
                   pval < 0.01 ~ "< 0.01", 
                   pval < 0.05 ~ "< 0.05", 
                   pval >= 0.05 ~ paste0("= ", sprintf('%.2f', pval)), 
                   TRUE ~ "")
}

cite_dat %<>% 
  mutate(estimate = sprintf('%.2f', estimate)) %>% 
  mutate(conf.low = sprintf('%.2f', conf.low)) %>% 
  mutate(conf.high = sprintf('%.2f', conf.high)) %>% 
  mutate(citation = paste0("OR = ", 
                          estimate, "; ",
                          "95% CI ", "[", conf.low, " - ", 
                          conf.high, "]; ", 
                          "p ", get_p_cite(p.value))) %>% 
  mutate(y.level = ifelse(y.level == "Progressive Populism", "prog", "trad"))

cite_complete <- function(mod, parameter, populism) {
  cite_dat %>%
    filter(model == mod) %>% 
    filter(term == parameter) %>% 
    filter(y.level == populism) %>% 
    select(citation) %>% .$citation
}

cite_OR <- function(mod, parameter, populism) {
  cite_dat %>%
    filter(model == mod) %>% 
    filter(term == parameter) %>% 
    filter(y.level == populism) %>% 
    select(estimate) %>% .$estimate 
}

cite_complete(mod = "control", 
              parameter = "age", 
              populism = "prog")

cite_OR(mod = "control", 
              parameter = "age", 
              populism = "prog")


save(cite_dat, file = "data/cite_dat.Rdata")
```


## Plot Predictions - Singular

```{r}
# test <- multinom(
#   populism2 ~
#     # economic deprivation
#     econ_unsat + econ_insec + unemployed +
#     # cultural backlash
#     anti_imm + openness + conservation + selfenhance + selftrans + globalism + govsat +
#     # control variables
#     age + educ + sex + lrscale + ethnic + religion + rural + east + north + south,
#     #data
#     data = mlogit_ess, weights = pweight)
# 
# 
# screenreg(test)

## Automatic Picking of Scales
#from_to <- as.vector(names(table(ess_mlogit$openness)))
#fit.eff <- effects::effect("openness", 
#                           test, 
#                           xlevels = list(openness = from_to))
## or
#fit.eff <- effects::effect("openness", 
#                           test)
## or put them in by hand
fit.eff <- effects::effect("anti_imm", 
                           fit3, 
                           xlevels = list(anti_imm = c(1:10)))

fit.eff$prob %>% 
  as.data.frame() %>% 
  #janitor::clean_names() %>% 
  summarise_all(mean) %>% 
  t() %>% 
  as.data.frame() %>% 
  rownames_to_column(var = "type") -> ame_dat

data.frame(fit.eff$model.matrix, 
           fit.eff$prob, 
           fit.eff$lower.prob, 
           fit.eff$upper.prob) %>% 
  select(anti_imm, prob.Traditionalist.Populism, prob.Establishment,
         prob.Progressive.Populism, L.prob.Establishment, 
         U.prob.Establishment, L.prob.Traditionalist.Populism, 
         U.prob.Traditionalist.Populism, L.prob.Progressive.Populism, 
         U.prob.Progressive.Populism, -X.Intercept.) %>% 
  gather(key = variable, value = value, -anti_imm, 
           -L.prob.Establishment, -U.prob.Establishment,
           -L.prob.Traditionalist.Populism, -U.prob.Traditionalist.Populism,
         -L.prob.Progressive.Populism, -U.prob.Progressive.Populism) %>% 
  mutate(type = case_when(
    str_detect(variable, "Traditionalist") ~ "Tradionalist Populism",
    str_detect(variable, "Progressive") ~ "Progressive Populism",
    str_detect(variable, "Establishment") ~ "Establishment"
  )) %>%
    mutate(lower = case_when(
    type == "Establishment" ~ L.prob.Establishment*100,
    type == "Progressive Populism" ~ L.prob.Progressive.Populism*100,
    type == "Tradionalist Populism" ~ L.prob.Traditionalist.Populism*100
  )) %>% 
    mutate(upper = case_when(
    type == "Establishment" ~ U.prob.Establishment*100,
    type == "Progressive Populism" ~ U.prob.Progressive.Populism*100,
    type == "Tradionalist Populism" ~ U.prob.Traditionalist.Populism*100
  )) %>% 
  mutate(value = value * 100) %>% 
  ggplot(aes(anti_imm, value, colour = type)) +
    geom_smooth(method = "loess", 
               #formula = y ~ s(x, k = 1), 
               size = 1.2, se = F) +
    geom_ribbon(aes(ymin = lower, ymax = upper), 
               fill = "gray70", alpha = 0.5, colour=NA) +
  geom_text(data = ame_dat, aes(label = V1)) +
 #  geom_jitter(alpha = 0.01) +
  labs(y = "Marginal Probability") +
  guides(color = F) +
    ggthemes::theme_hc() +
    ggthemes::scale_color_fivethirtyeight() + 
    facet_wrap(~type, scales = "free", ncol = 1) +
    scale_y_continuous(breaks = seq(0,100, by = 3), 
                     labels = paste0(seq(0,100, by = 3),"%"))

ggsave(filename = "images/anti_imm.png", height = 8)
```

## Plot Predictions - Interactions

```{r}
test <- multinom(
  populism2 ~
    # economic deprivation
    econ_unsat + econ_insec + unemployed +
    # cultural backlash
    anti_imm + openness + conservation + selfenhance + selftrans + globalism + govsat +
    # control variables
    age + educ + sex + lrscale + ethnic + religion + rural + east + north + south +
    # interactions
    anti_imm*unemployed , 
    #data
    data = mlogit_ess, weights = pweight)

screenreg(test)

from_to <- as.vector(names(table(mlogit_ess$anti_imm)))
#table(mlogit_ess$govsat)
# fit.eff <- effects::effect("anti_imm*south", test, xlevels = list(govsat = from_to))

fit.eff <- effects::Effect(c("anti_imm", "unemployed"), 
                           fit4, 
                           xlevels = list(anti_imm = from_to, 
                                          unemployed = c(0, 1)))


data.frame(fit.eff$model.matrix, 
           fit.eff$prob, 
           fit.eff$lower.prob, 
           fit.eff$upper.prob) %>% 
  select(anti_imm, unemployed, # interaction effects
         prob.Traditionalist.Populism, prob.Establishment,
         prob.Progressive.Populism, L.prob.Establishment, 
         U.prob.Establishment, L.prob.Traditionalist.Populism, 
         U.prob.Traditionalist.Populism, L.prob.Progressive.Populism, 
         U.prob.Progressive.Populism, -X.Intercept.) %>% 
  gather(key = variable, value = value, 
         -anti_imm, -unemployed, # interaction effects 
           -L.prob.Establishment, -U.prob.Establishment,
           -L.prob.Traditionalist.Populism, -U.prob.Traditionalist.Populism,
         -L.prob.Progressive.Populism, -U.prob.Progressive.Populism) %>% 
  mutate(type = case_when(
    str_detect(variable, "Traditionalist") ~ "Tradionalist Populism",
    str_detect(variable, "Progressive") ~ "Progressive Populism",
    str_detect(variable, "Establishment") ~ "Establishment"
  )) %>% 
    mutate(lower = case_when(
    type == "Establishment" ~ L.prob.Establishment*100,
    type == "Progressive Populism" ~ L.prob.Progressive.Populism*100,
    type == "Tradionalist Populism" ~ L.prob.Traditionalist.Populism*100
  )) %>% 
    mutate(upper = case_when(
    type == "Establishment" ~ U.prob.Establishment*100,
    type == "Progressive Populism" ~ U.prob.Progressive.Populism*100,
    type == "Tradionalist Populism" ~ U.prob.Traditionalist.Populism*100
  )) %>% 
  mutate(value = value * 100) %>% 
  mutate(Unemployed = as.factor(unemployed)) %>% 
  # mutate(unemployed = as.factor(case_when( 
  #   unemployed == max(unemployed) ~ max(unemployed),
  #   unemployed == min(unemployed) ~ min(unemployed),  
  #   TRUE ~ NA_real_
  # ))) %>% 
  #drop_na(unemployed) %>% 
  ggplot(aes(anti_imm, value, group = Unemployed, colour = Unemployed)) +
    geom_smooth(method = "loess", 
               #formula = y ~ s(x, k = 1), 
               size = 1.2, se = F) +
    geom_ribbon(aes(ymin = lower, ymax = upper), 
               fill = "gray70", alpha = 0.5, colour=NA) +
    scale_colour_manual("", values = c("blue", "red")) +
 #  geom_jitter(alpha = 0.01) +
    labs(y = "Marginal Probability") +
    ggthemes::theme_hc() +
    ggthemes::scale_color_fivethirtyeight() + 
    facet_wrap(~type, scales = "free") +
    scale_y_continuous(breaks = seq(0,100, by = 5), 
                     labels = paste0(seq(0,100, by = 5),"%")) +
  xlab("Anti-Immigration Sentiment") +
  ggtitle("Probabilities of Support for Establishment/Populist Parties") +
  labs(subtitle = "Based on Multinomial Logistic Regression",
       caption = "Source: ESS Data Round 5 - 8") +
  theme(axis.text = element_text(size = 10),
        axis.title = element_text(size = 10),
        legend.text = element_text(size = 10), 
        legend.title = element_text(size = 10), 
        title = element_text(size = 12))


# ggsave(file = here::here("images", "interaction_abstract.png"), 
#        height = 5, width = 8)
```


## Appropriateness

```{r}
head(pp <- fitted(test))
#head(pp <- predict(test, newdata = mlogit_ess, type = "class"))

conf.beta <- confint(object = test , level = 0.95)
conf.beta # Results are in a 3D array

table(pp, mlogit_ess$populism2)

broom::tidy(test)

probs <- pp %>% 
  as_tibble() %>% 
  cbind(mlogit_ess) %>%
  as.data.frame()


 table(mlogit_ess$cntry)

probs %<>% 
  mutate(estab = ifelse(populism2 == "Establishment", T, F)) %>% 
  mutate(lib = ifelse(populism2 == "Progressive Populism", T, F)) %>% 
  mutate(illib = ifelse(populism2 == "Traditionalist Populism", T, F)) 

table(probs$`Traditionalist Populism`>probs$`Progressive Populism` & probs$`Traditionalist Populism`>probs$Establishment, probs$illib)
table(probs$`Progressive Populism`>probs$`Traditionalist Populism` & probs$`Progressive Populism`>probs$Establishment, probs$lib)
table(probs$Establishment>probs$`Progressive Populism` & probs$Establishment>probs$`Traditionalist Populism`, probs$estab)
table(probs$populism2)

checkers <- probs %>% 
  filter(populism2 != "Establishment")

table(checkers$`Traditionalist Populism`>checkers$`Progressive Populism`, checkers$illib)
table(checkers$`Progressive Populism`>checkers$`Traditionalist Populism`, checkers$lib)
table(probs$populism2)
```


## Predictions

```{r}


plot_probs <- function(probs = probs, variable = probs$anti_imm) {
  ss <- probs %>% 
  mutate(variable = as.numeric(variable)) %>% 
  select(variable, `Traditionalist Populism`, `Progressive Populism`, Establishment) %>% 
#  mutate(id = n()) %>% 
  gather(key = variable, value = value)  

names(ss) <- c("variable", "type", "value")

ss %>% 
  mutate(value = value * 100) %>% 
   ggplot(aes(variable, value, colour = type)) +
   geom_smooth(method = "gam", 
               formula = y ~ s(x, k = 1), 
               size = 1.2) +
 #  geom_ribbon(aes(ymin = LO, ymax = HI), fill = "gray70", alpha = 0.5) +
 #  geom_jitter(alpha = 0.01) +
  labs(x = str_glue("{names(ss)[1]}"), y = "Marginal Probability") +
  ggthemes::theme_hc() +
  ggthemes::scale_color_fivethirtyeight() + 
  facet_wrap(~type, scales = "free") +
  scale_y_continuous(breaks = seq(0,100, by = 5), 
                     labels = paste0(seq(0,100, by = 5),"%"))
}

plot_ints <- function(probs, variable = NULL, 
                      variable2 = NULL, type = "minmax", legend_title = "variable") {
#  if (type == "minmax") {

#}
  
ss <- probs %>% 
  mutate(variable = as.numeric(variable)) %>% 
  mutate(variable2 = as.numeric(variable2)) %>% 
  select(variable, variable2, `Traditionalist Populism`, 
         `Progressive Populism`, Establishment) %>% 
    mutate(variable2 = case_when(
    variable2 == max(variable2) ~ max(variable2),
    variable2 == min(variable2) ~ min(variable2),  
    TRUE ~ NA_real_
  )) %>% 
  drop_na(variable2) %>% 
#  mutate(id = n()) %>% 
  gather(key = "type", value = "value", -variable, -variable2) %>% 
  mutate(value = value * 100) 



# if (type == "sd") {
#   ss <- probs %>% 
#     mutate(variable2 = case_when(
#     variable2 == mean(variable2, na.rm = T) + 2*sd(variable2) max(variable2) ~ max(variable2),
#     variable2 == min(variable2) ~ min(variable2),  
#     TRUE ~ NA_real_
#   )) %>% 
#   drop_na(variable2) 
# }

ss %>% 
   ggplot(aes(variable, value, 
              colour = as.factor(variable2), group = variable2)) +
   geom_smooth(method = "gam", 
               formula = y ~ s(x, k = 1), 
               size = 1.2) +
 #  geom_jitter(alpha = 0.01) +
  labs(x = str_glue("{names(ss)[1]}"), y = "Marginal Probability") +
  ggthemes::theme_hc() +
#  scale_colour_hue("", l = 70, c = 150, h = c(90, 20)) + 
  scale_colour_manual(legend_title, values = c("blue", "red")) +
  facet_wrap(~type, scales = "free") +
  scale_y_continuous(breaks = seq(0,100, by = 5), 
                     labels = paste0(seq(0,100, by = 5),"%"))
}

plot_probs(probs, probs$religion)

ggsave(filename = "images/probabs.png", height = 5, width = 12)
# 
# variable <- mlogit_ess$econ_unsat
# variable2 <- mlogit_ess$anti_imm




plot_ints(probs, probs$anti_imm, probs$unemployed)

plot_ints(probs, probs$anti_imm, probs$unemployed, legend_title = "Unemployed over 3 Months") +
  xlab("Anti-Immigration Sentiment")

ggsave(filename = "images/interaction1.png", height = 5, width = 12)


plot_ints(probs, probs$anti_imm, probs$econ_insec, legend_title = "Economic Insecurity") +
  xlab("Anti-Immigration Sentiment")

ggsave(filename = "images/interaction2.png", height = 5, width = 12)


```

# Logistic Regression

```{r}
mlogit_ess %<>% 
  mutate(progressive_populism = ifelse(target == "Progressive Populism", 1, 0)) %>% 
  mutate(trad_populism = ifelse(target == "Traditionalist Populism", 1, 0))   

glmfit <- glm(progressive_populism ~ 
    # economic deprivation
    econ_unsat + econ_insec + unemployed +
    # cultural backlash
    anti_imm + authoritarianism + globalism +
    # control variables
    demsat + trust_gov + govsat + age + educ +  + sex ,
    #data
    data = mlogit_ess, weights = pweight, family = "binomial")

plot_model(glmfit)
screenreg(glmfit)
stargazer(glmfit, type = "text")


nagelkerke(glmfit)

plot_model(glmfit, type = "pred", terms = c("econ_unsat", "unemployed"))

predict(glmfit, mlogit_ess, type = "response") %>% 
  data.frame(predict_prog = .) %>% 
  transmute(predict_prog = predict_prog>=0.5) %>% 
  cbind(mlogit_ess) %>% 
  select(predict_prog, progressive_populism) %>% 
  table()

# Use your model to make predictions, in this example newdata = training set, but replace with your test set    
pdata <- predict(glmfit, newdata = mlogit_ess, type = "response")

# use caret and compute a confusion matrix
confusionMatrix(data = as.numeric(pdata>0.5), reference = mlogit_ess$progressive_populism)

glmfit <- glm(trad_populism ~ 
    # economic deprivation
    econ_unsat + econ_insec + unemployed +
    # cultural backlash
    anti_imm + authoritarianism + globalism +
    # control variables
    demsat + trust_gov + govsat + age + educ +  + sex ,
    #data
    data = mlogit_ess, weights = pweight, family = "binomial")

predict(glmfit, mlogit_ess, type = "response") %>% 
  data.frame(predict_trad = .) %>% 
  transmute(predict_trad = predict_trad>=0.5) %>% 
  cbind(mlogit_ess) %>% 
  select(predict_trad, trad_populism) %>% 
  table()

plot_model(glmfit)
screenreg(glmfit)

plot_model(glmfit, type = "pred", terms = c("econ_unsat"))
```




# Crap


## Human Values

```{r}
# selected <- binoculaR::binoculaR(ess)
# 
# 
# fa_dat <- ess %>%
#   select(selected$var_codes)

#save(fa_dat, file = "data/fa_dat.Rdata")


# openness_dat <- fa_dat %>% 
#   select(ipcrtiv, impfree, impdiff, ipadvnt, ipgdtim, impfun) %>% 
#   psych::pca(1) 
#   #psych::alpha()
# 
# openness_dat %>% 
#   predict(., data = fa_dat)

# pacman::p_install_gh("yrosseel/lavaan")
# 
# fa_model <- 'openness =~ ipcrtiv + impfree + impdiff + ipadvnt + ipgdtim + impfun
#              ipgdtim ~~ impfun
#              ipcrtiv ~~ impfree
#              ipcrtiv ~~ impdiff
#              impfree ~~ ipadvnt'
# 
# 
# fit <- cfa(fa_model, data=fa_dat, 
#                    estimator= "MLM")
# 
# summary(fit, standardized=TRUE, 
#         fit.measures = TRUE, rsq = T)
# 
# openness <- lavaan::lavPredict(fit, newdata = fa_dat, fsm = T)
# 
# #Modifikationsindizes
# modheit <- modificationindices(fit, sort=T, minimum.value = 5)
# modheit
```

## crap 2

```{r}

library(rstan)

p <- predict(test)
table(p)
z <- summary(test)$coefficients/summary(test)$standard.errors
z

# 2-tailed z test
p <- (1 - pnorm(abs(z), 0, 1)) * 2
p

## extract the coefficients from the model and exponentiate
exp(coef(test))

head(pp <- fitted(test))

library(mlogit)
m <- mlogit(populism2 ~ imm_culture, data = mlogit_ess)
# compute a data.frame containing the mean value of the covariates in the sample
z <- with(mlogit_ess, data.frame(price = tapply(price, index(m)$alt, mean), 
	catch = tapply(catch, index(m)$alt, mean), 
econ_insec = mean(econ_insec)))
# compute the marginal effects (the second one is an elasticity
effects(m, covariate = "econ_insec", data = z)
effects(m, covariate = "price", type = "rr", data = z)
effects(m, covariate = "catch", type = "ar", data = z)

library(mnlogit)
#data(Fish, package = "mnlogit")
fm <- formula(populism2 ~ imm_culture )
fit <- mnlogit(fm, mlogit_ess, choiceVar="Establishment", ncores = 2)

### With improper prior it takes about 12 minutes, with about 40% CPU utilization and fans running,
### so you probably don't want to casually run the next line...

system.time (b1 <- brm (populism ~ imm_culture, 
                        data=mlogit_ess,
                        family="categorical", 
                        n.chains=3, 
                        n.iter=3000, 
                        n.warmup=600))
```



## Descriptives

```{r}

# pacman::p_install_gh("systats/binoculaR")
# 
# binoculaR::binoculaR(ess)

# ess %>% 
#   select(prtvede1, prtvede2) %>% na.omit() %>% mutate_all(sjmisc::to_label)

#var_label(ess$imueclt)

#ir <- data.frame (scale (iris[, -5]), Species=iris[, 5])


```


## Applying a different approach

```{r}

#install.packages("mlogit")    
# This is my favorite package to do multinomial logit in R

options(scipen=9)    # To fix notation
# library(MASS)
library(xtable)
library(mlogit)
library(reshape2)    # We will need this package at the very end


mnl.1 <- mlogit(populism2 ~ 1 |
    # economic deprivation
    econ_unsat + econ_insec + unemployed +
    # cultural backlash
    anti_imm + authoritarianism + globalism +
    # control variables
    demsat + trust_gov + govsat + age + educ + sex + lrscale + ethnic + religion + rural,
                data = mlogit_ess, shape = "wide", reflevel = "Establishment", weights = pweight)
summary(mnl.1)

betas <- coef(mnl.1)
varcov <- vcov(mnl.1)
# se <- sqrt(diag(mnl.1))

# betas[1]
# 
# # broom::tidy(mnl.1)
# stargazer(mnl.1, type = "text")

#Let’s set up the simulation.

set.seed(461982)
n <- 1000
sim.pred <- MASS::mvrnorm(n, betas, varcov)


#Extract the variable names.
c.n.2 <- names(betas)[names(betas) %>% str_detect("Traditionalist Populism")]
c.n.3 <- names(betas)[names(betas) %>% str_detect("Progressive Populism")]


#Set the independent variables to some meaningful values storing them into an object.

means <- c(mean(mlogit_ess$econ_unsat, na.rm = T), 
           mean(mlogit_ess$econ_insec, na.rm = T), 
           1, # Employed
           mean(mlogit_ess$anti_imm, na.rm = T),
           mean(mlogit_ess$authoritarianism, na.rm = T), 
           mean(mlogit_ess$globalism, na.rm = T), 
           mean(mlogit_ess$demsat, na.rm = T), 
           mean(mlogit_ess$trust_gov, na.rm = T),
           mean(mlogit_ess$govsat, na.rm = T), 
           mean(mlogit_ess$age, na.rm = T), 
           mean(mlogit_ess$educ, na.rm = T),
           1, #sex
           mean(mlogit_ess$lrscale, na.rm = T),
           1, #ethnic
           mean(mlogit_ess$religion, na.rm = T), 
           mean(mlogit_ess$rural, na.rm = T))

means <- data.frame(econ_unsat = mean(mlogit_ess$econ_unsat, na.rm = T), 
           econ_insec = mean(mlogit_ess$econ_insec, na.rm = T), 
           unemployed = 1, # Employed
#           anti_imm = mean(mlogit_ess$anti_imm, na.rm = T),
           authoritarianism = mean(mlogit_ess$authoritarianism, na.rm = T), 
           globalism = mean(mlogit_ess$globalism, na.rm = T), 
           demsat = mean(mlogit_ess$demsat, na.rm = T), 
           trust_gov = mean(mlogit_ess$trust_gov, na.rm = T),
           govsat = mean(mlogit_ess$govsat, na.rm = T), 
           age = mean(mlogit_ess$age, na.rm = T), 
           educ = mean(mlogit_ess$educ, na.rm = T),
           sex = 1,
           lrscale = mean(mlogit_ess$lrscale, na.rm = T),
           ethnic = 1,
           religion = mean(mlogit_ess$religion, na.rm = T), 
           rural = mean(mlogit_ess$rural, na.rm = T))
)
           
x.range <- seq(min(mlogit_ess$anti_imm, na.rm = T), max(mlogit_ess$anti_imm, na.rm = T), along.with = min(mlogit_ess$anti_imm, na.rm = T):max(mlogit_ess$anti_imm, na.rm = T))

#Create empty matrices for the predictions.
res.1 <- matrix(NA, nrow = length(x.range), ncol = 4)
res.2 <- matrix(NA, nrow = length(x.range), ncol = 4)
res.3 <- matrix(NA, nrow = length(x.range), ncol = 4)

#Run the loop.
i = 2
for(i in 1:length(x.range)){
  a <- x.range[i]
  # Generate vectors of predictions on the linear predictor
  b.2 <- sim.pred[, c.n.2]%*%c(1, means,a)
  b.3 <- sim.pred[, c.n.3]%*%c(1, means,a)
  # Generate vectors of probabilities (notice that category 1 is the baseline)
  p.1 <- 1/(1 + exp(b.2) + exp(b.3))
  p.2 <- exp(b.2)/(1 + exp(b.2) + exp(b.3))
  p.3 <- exp(b.3)/(1 + exp(b.2) + exp(b.3))
  # Put means and CIs in 4 matrices
  res.1[i, ] <- c(a,
                  mean(p.1), 
                  quantile(p.1, p = 0.025),
                  quantile(p.1, p = 0.975))
  res.2[i, ] <- c(a,
                  mean(p.2), 
                  quantile(p.2, p = 0.025),
                  quantile(p.2, p = 0.975))
  res.3[i, ] <- c(a,
                  mean(p.3), 
                  quantile(p.3, p = 0.025),
                  quantile(p.3, p = 0.975))
}

data.sim <- data.frame(rbind(res.1, res.2, res.3))
names(data.sim) <- c("X", "Y", "LO", "HI")
data.sim$GR <- rep(c("Establishment", "Traditional Populism", "Progressive Populism"), each = length(x.range))


install.packages("VGAM")
VGAM::margeff(test)


ggplot(data.sim, aes(x = X, y = Y, group = GR)) +
  geom_line() +
  geom_ribbon(aes(ymin = LO, ymax = HI), fill = "gray70", alpha = 0.5) +
  facet_wrap(~ GR, ncol = 3) +
  scale_y_continuous(limits = c(0,1)) +
#  scale_x_continuous(breaks = seq(0, 10, by = 1)) +
  xlab("Religiosity") +
  ylab("Probability to vote for party") +
  theme_bw()
```


# Trees

```{r}
tre_ess <- mlogit_ess %>% 
  mutate(progressive_populism = ifelse(target == "Progressive Populism", 1, 0)) %>% 
  mutate(trad_populism = ifelse(target == "Traditionalist Populism", 1, 0)) %>%    
  select(progressive_populism, unemployed, anti_imm)  
  
#pacman::p_load(FFTrees)
fft_populism <- FFTrees(formula = progressive_populism ~.,
                    data = tre_ess,
                    main = "Populism",
                    decision.labels = c("Establishment", "Traditional Populism"))

plot(fft_populism)



```